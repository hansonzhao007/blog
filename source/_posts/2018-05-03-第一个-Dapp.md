---
title: 第一个 Dapp
mathjax: false
comments: true
author: XS Zhao
categories:
  - blockchain
tags:
  - dapp
  - ethereum
image: 'http://hansonzhao007.github.io/blog/images/infinite1.gif'
abbrlink: 58511
date: 2018-05-03 14:40:59
subtitle:
keywords:
description:
---

# 配置开发环境
## 安装 [Nodejs](https://nodejs.org)
Mac 上安装 nodejs：
```bash
brew install node
```

## 安装 [Truffle](http://truffleframework.com/)
```bash 
npm install -g truffle # http://truffleframework.com/
```
truffle 是一个用于在 Etherem 上开发 Dapp 的框架。它让我们能够用 solidity 编程语言去写 Dapp 并进行调试。

## 安装 [Ganache](http://truffleframework.com/ganache/)
Ganache 是一个本地的 in memory blockchain，让我们用于测试自己编写的 Dapp
![](1.png)

## 安装 [Metamask](https://metamask.io/) google 插件
为了能够使用 ethereum blockchain，我们需要安装 Google Chrome 的 METAMASK 扩展插件。使用 METAMASK 就可以让我们连接到本地的 etherum blockchain (Ganache 创建的)，并和我们的 smart contract 做交互。
![](2.gif)

<!-- more -->
## 快速部署 truffle 项目
truffle 给我们提供了模板（这里称作为 box），用于我们进行快速开发。所以只要使用 `unbox` 命令来解压模板，就可以了。
```bash
mac@macs-macbook  ~/Code/blockchain/election  truffle unbox pet-shop
Downloading...
Unpacking...
Setting up...
Unbox successful. Sweet!

Commands:

  Compile:        truffle compile
  Migrate:        truffle migrate
  Test contracts: truffle test
  Run dev server: npm run dev
```


# 编写代码
## 示例1
分别在 contracts 和 migrations 文件夹创建如下代码：
![](4.png)
![](5.png)

```bash :./contracts/Election.sol
pragma solidity ^0.4.11;
contract Election {
    // Read cnadidate
    string public candidate;
    // Constructor
    constructor() public {
        candidate = "Candidate 1";
    }
}
```

```bash :./migrations/2_deploy_contracts.js
var Election = artifacts.require("./Election.sol");
module.exports = function(deployer) {
  deployer.deploy(Election);
};
```
### 获取 smart contract 的 instance（实例）
Election 是我们定义的 contract 名。
首先使用如下命令，将我们定义的 smart contract 发布到 blockchain 中。
```bash
truffle migrate
```
需要注意的是，每次 deploy 一个 smart contract 都会消耗 ETH，这里消耗了 0,05 的 gas。
![](3.png)
然后使用下面的命令，获取 smart contract 的一个 instance（实例）：
```bash
mac@macs-macbook  ~/Code/blockchain/election  truffle console
truffle(development)> Election.deployed().then( function (instance) { app = instance })
undefined
truffle(development)> app.address
'0x139c2cafabda6bd79b41e0d484e5ad440adf4bcb'
truffle(development)> app.candidate()
'Candidate 1'
```

## 示例2
下面使用一个新的 smart contract 实现投票的 Dapp。
```bash :./contracts/Election.sol
pragma solidity ^0.4.11;

contract Election {
    struct Candidate{
        uint id;
        string name;
        uint voteCount;
    }
    mapping(uint => Candidate) public candidates;
    uint public candidatesCount;

    constructor() public {
        addCandidate("Tom");
        addCandidate("Jerry");
    }
    
    function addCandidate (string _name) private {
        candidatesCount ++;
        candidates[candidatesCount] = Candidate(candidatesCount, _name, 0);
    }
}
```

而后在 terminal 里面重新 deploy 一下该 contract。因为 contract 的代码被修改了，所以需要 reset。
```bash
truffle migrate --reset
```

之后重新进入 console 查询状态：
```bash
mac@macs-macbook  ~/Code/blockchain/election  truffle console
truffle(development)> Election.deployed().then( function (instance) { app = instance })
undefined
truffle(development)> app.candidates(1)
[ BigNumber { s: 1, e: 0, c: [ 1 ] },
  'Tom',
  BigNumber { s: 1, e: 0, c: [ 0 ] } ]
truffle(development)> app.candidates(2)
[ BigNumber { s: 1, e: 0, c: [ 2 ] },
  'Jerry',
  BigNumber { s: 1, e: 0, c: [ 0 ] } ]
truffle(development)> app.candidates(99) # 这里因为没有 key 为99的 candidate，所以返回空
[ BigNumber { s: 1, e: 0, c: [ 0 ] },
  '',
  BigNumber { s: 1, e: 0, c: [ 0 ] } ]
truffle(development)> app.candidatesCount()
BigNumber { s: 1, e: 0, c: [ 2 ] }
```

## 获取指定 candidate 的值
在 smart contract 中，value 的获取是 async 的，所以不可以将赋值写为：`candidate = app.candidates(1)`。必须在回调函数里面赋值：
```bash
truffle(development)> app.candidates(1).then( function(c) { candidate = c;})
undefined
truffle(development)> candidate
[ BigNumber { s: 1, e: 0, c: [ 1 ] },
  'Tom',
  BigNumber { s: 1, e: 0, c: [ 0 ] } ]
# 获取得到的 candidate struct 里对应的 id，name，voteCount 值
truffle(development)> candidate[0].toNumber()
1
truffle(development)> candidate[1]
'Tom'
truffle(development)> candidate[2].toNumber()
0
```

## 查看 blockchain 中的 account
在 Ganache 中，我们创建了 10 个 accounts
![](6.png)

同时这些账户可以在 truffl 的 console 里面使用 web3 查找到。
```bash
truffle(development)> web3.eth.accounts
[ '0xdde9664954edb28dc2afb866e668447256b15365',
  '0x062f0fb7e869943884698ec2bd67d8de1e612eac',
  '0x26d8d3a6e3c84775150939505b407ebef4391f8e',
  '0x31de3718ca3a2d6e0df954fe585b1bee596e0642',
  '0x00645cf254bdb1ff4004c1f91a17a71032eb8bbf',
  '0x6c8fdd7a767e8182270b301c83974a614b6d79b3',
  '0x8d29c76eb9f4d978defe7e624ca95207e926fcb8',
  '0xecad6764d5eacaf402ae61726c5768866c15ee4b',
  '0xa2f4ba6a56c738f968e1509851b84de27207bcc3',
  '0xf654b8f4bbee0a95cab96aabf3fddb77813b493e' ]
```

## 编写测试用例
